name: NAS Build and Deploy

on:
  push:
    branches: [ "master" ]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: [self-hosted]

    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v3

      - name: Build Docker Image
        run: |
          echo "ğŸ”¨ Docker ì´ë¯¸ì§€ ë¹Œë“œ ì‹œì‘..."
          # docker build --no-cache -t [ì´ë¯¸ì§€ëª…]:[íƒœê·¸] [Dockerfileìœ„ì¹˜]
          docker build --no-cache -t sportslab:latest ./frontend

      - name: Deploy to NAS
        run: |
          echo "ğŸ›‘ ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ë‹¨ ë° ì‚­ì œ..."
          docker stop sportslab-web || true
          docker rm sportslab-web || true
          
          echo "ğŸš€ ìƒˆ ì»¨í…Œì´ë„ˆ ì‹¤í–‰..."
          # [ìˆ˜ì •ë¨] ì¤„ë°”ê¿ˆ ë¬¸ì(\)ë¥¼ ì¶”ê°€í•˜ì—¬ ëª…ë ¹ì–´ê°€ ëŠê¸°ì§€ ì•Šë„ë¡ ìˆ˜ì •í–ˆìŠµë‹ˆë‹¤.
          docker run -d \
            --name sportslab-web \
            --restart unless-stopped \
            -p 3000:3000 \
            -e TZ=Asia/Seoul \
            -e DB_HOST=onno.synology.me \
            -e DB_PORT=54321 \
            -e DB_USERNAME=hongun \
            -e DB_PASSWORD=Dlskdud240! \
            -e DB_NAME=sportslab \
            sportslab:latest
            
      - name: Clean up
        run: |
          docker image prune -f