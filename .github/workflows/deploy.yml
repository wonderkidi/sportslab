name: NAS Build and Deploy

on:
  push:
    branches: [ "master" ]  # master ë¸Œëœì¹˜ì— í‘¸ì‹œë  ë•Œ ì‹¤í–‰
  workflow_dispatch:        # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

jobs:
  build-and-deploy:
    # [ì¤‘ìš”] GitHub ì„œë²„ê°€ ì•„ë‹Œ ë‚´ NASì—ì„œ ì‹¤í–‰
    runs-on: [self-hosted]

    steps:
      # 1. ìµœì‹  ì½”ë“œ ë‚´ë ¤ë°›ê¸°
      - name: Checkout Source Code
        uses: actions/checkout@v3

      # 2. ë„ì»¤ ì´ë¯¸ì§€ ë¹Œë“œ (Docker Hub ë¡œê·¸ì¸ ë¶ˆí•„ìš”)
      - name: Build Docker Image
        run: |
          echo "ğŸ”¨ Docker ì´ë¯¸ì§€ ë¹Œë“œ ì‹œì‘..."
          # [ì¤‘ìš”] ./frontend í´ë”ë¥¼ ë¹Œë“œ ê²½ë¡œë¡œ ì§€ì •í•©ë‹ˆë‹¤.
          # ì´ë¯¸ì§€ ì´ë¦„: sportslab, íƒœê·¸: latest
          docker build --no-cache -t sportslab:latest ./frontend

      # 3. ê¸°ì¡´ ì»¨í…Œì´ë„ˆ êµì²´ ë° ì¬ì‹¤í–‰
      - name: Deploy to NAS
        run: |
          echo "ğŸ›‘ ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ë‹¨ ë° ì‚­ì œ..."
          docker stop sportslab-web || true
          docker rm sportslab-web || true
          
          echo "ğŸš€ ìƒˆ ì»¨í…Œì´ë„ˆ ì‹¤í–‰..."
          docker run -d \
            --name sportslab-web \
            --restart unless-stopped \
            -p 3000:3000 \
            -e TZ=Asia/Seoul \
            -e DB_HOST=onno.synology.me  \
            -e DB_PORT=54321 \
            -e DB_USERNAME=hongun \
            -e DB_PASSWORD=Dlskdud240! \
            -e DB_NAME=sportslab
            sportslab:latest
            
      # 4. ë¶ˆí•„ìš”í•œ ì´ë¯¸ì§€ ì •ë¦¬ (NAS ìš©ëŸ‰ ì ˆì•½)
      - name: Clean up
        run: |
          docker image prune -f