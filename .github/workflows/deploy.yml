name: NAS Build and Deploy

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: [self-hosted]

    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v3

      - name: Build Docker Image
        run: |
          echo "ğŸ”¨ Docker ì´ë¯¸ì§€ ë¹Œë“œ ì‹œì‘..."
          # docker build --no-cache -t [ì´ë¯¸ì§€ëª…]:[íƒœê·¸] [Dockerfileìœ„ì¹˜]
          docker build --no-cache -t sportslab:latest ./frontend

      - name: Deploy to NAS
        run: |
          echo "ğŸ›‘ ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ë‹¨ ë° ì‚­ì œ..."
          docker stop sportslab-web || true
          docker rm sportslab-web || true
          
          docker run -d \
            --name sportslab-web \
            --restart unless-stopped \
            -p 3010:3010 \
            -e TZ=Asia/Seoul \
            -e NODE_ENV=production \
            -e DATABASE_URL='postgresql://hongun:Dlskdud240!@onno.synology.me:54321/sportslab?schema=public' \
            sportslab:latest
            
      - name: Clean up
        run: |
          docker image prune -f