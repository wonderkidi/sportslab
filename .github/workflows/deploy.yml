name: NAS Build and Deploy

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: [self-hosted]

    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v3

      - name: Build Docker Image
        run: |
          echo "ğŸ”¨ Docker ì´ë¯¸ì§€ ë¹Œë“œ ì‹œì‘..."
          
          # [ìˆ˜ì • í•µì‹¬ 1] --network host : ë¹Œë“œ ì»¨í…Œì´ë„ˆê°€ NAS ë„¤íŠ¸ì›Œí¬ë¥¼ ë°”ë¡œ ì“°ë„ë¡ ì„¤ì •
          # [ìˆ˜ì • í•µì‹¬ 2] --build-arg : Dockerfileì˜ ARG ë³€ìˆ˜ì— DB ì£¼ì†Œ ì£¼ì…
          # [ì£¼ì˜] IPì£¼ì†ŒëŠ” NAS ë‚´ë¶€ IP(ì˜ˆ: 192.168.0.x)ë¥¼ ì“°ëŠ” ê²ƒì´ ê°€ì¥ ì•ˆì „í•©ë‹ˆë‹¤.
          
          docker build --no-cache --network host \
            --build-arg DATABASE_URL='postgresql://hongun:Dlskdud240!@onno.synology.me:54321/sportslab?schema=public' \
            -t sportslab:latest ./frontend

      - name: Deploy to NAS
        run: |
          echo "ğŸ›‘ ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ë‹¨ ë° ì‚­ì œ..."
          docker stop sportslab-web || true
          docker rm sportslab-web || true
          
          echo "ğŸš€ ìƒˆ ì»¨í…Œì´ë„ˆ ì‹¤í–‰..."
          # [ìˆ˜ì • í•µì‹¬ 3] ì‹¤í–‰ ì‹œì—ë„ ë„¤íŠ¸ì›Œí¬ ëª¨ë“œë¥¼ hostë¡œ í•˜ê±°ë‚˜ í¬íŠ¸ë§¤í•‘ ìœ ì§€
          # ì—¬ê¸°ì„œëŠ” í¬íŠ¸ ë§¤í•‘ ë°©ì‹ì„ ìœ ì§€í–ˆìŠµë‹ˆë‹¤.
          
          docker run -d \
            --name sportslab-web \
            --restart unless-stopped \
            -p 3010:3010 \
            -e TZ=Asia/Seoul \
            -e NODE_ENV=production \
            -e DATABASE_URL='postgresql://hongun:Dlskdud240!@172.17.0.1:54321/sportslab?schema=public' \
            sportslab:latest
            
      - name: Clean up
        run: |
          docker image prune -f